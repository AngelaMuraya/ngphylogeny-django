{% load static %}
<script>
$(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip();
});


</script>
<script>
    $(function () {
        var deferreds = [];
        // Loop using .each
        $("[data]").each(function (index, value) {
            var ajax = $.post("{% url 'get_dataset_tool' history_info.id %}",
                {
                    'dataset_id': $(this).attr('id'),
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                function (response) {
                    var result = response;
                    $('#' + result.dataset_id).attr('data', result.tool_id)
                });
            // Push promise to 'deferreds' array
            deferreds.push(ajax);
        });
        // Use .apply onto array from deferreds
        $.when.apply($, deferreds).then(function () {
            // groupe dataset by tool
            var id_tool = '';
            var first_dataset = '';
            var cmpt = 1;

            $("[data]").each(function (index, el) {

                if (id_tool == $(el).attr('data')) {
                    cmpt++;
                    $(el).remove();
                } else {
                    cmpt = 1;
                    first_dataset = $(el).attr('id');
                    id_tool = $(el).attr('data');
                    $.post("{% url 'get_tool_name' %}",
                        {
                            'tool_id': $(this).attr('data'),
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        function (response) {
                            var result = response;
                            $(el).text(result.name);
                        });
                }
                $('#' + first_dataset).attr('rowspan', cmpt);
            });
        });
    });
</script>

<script>
    function refresh() {
        $.get('{% url 'history_detail' history_info.id %}',
            function (data) {
                var html = $.parseHTML(data);
                var nbstate = $(html).find('[id^=state_]').length
                if ($('[id^=state_]').length != nbstate )
                { location.reload();}
                $(html).find('[id^=state_]').each(function (index, el) {
                    $('#' + $(el).attr('id')).replaceWith($(el));
                });
                $(html).find('[id^=action_]').each(function (index, el) {
                    $('#' + $(el).attr('id')).replaceWith($(el));
                });
            }
        );
    }
    function renameHistory(el){
        $.post("{% url 'history_rename' history_info.id %}",
                {
                    name: el.value,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                }
            );
        }
</script>

<div class="alert alert-info alert-dismissable fade in">
    <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
    <strong>Info !</strong> This page page is refreshed every 5sec.
</div>

<p class="pull-right">
    <a onclick="refresh()" class="btn btn-primary">
        <span class="glyphicon glyphicon-refresh"></span> Refresh
    </a>
</p>
<div class="row">
    <div class="col-md-8">
        <div class="input-group" onclick="$('#rename_history').focus();">
            <div class="input-group-addon">
                Title
            </div>
            <input id="rename_history" class="form-control input-lg" onblur="renameHistory(this);"
                   value="{{ history_info.name }}â€‹"></span>
            <span class="input-group-addon">
       <span class="glyphicon glyphicon-pencil"
             title="Rename your analyse"
             data-toggle="tooltip" data-placement="right">
        </span>
    </span>
        </div>
    </div>
</div>
<br>
<br>
<div class="row">
    <div class="col-md-12">
        <table class="table table-striped ">
            <thead>
            <th>Tool</th>
            <th>Step</th>
            <th>File Name</th>
            <th>Status</th>
            </thead>
            {% for file in history_content|dictsortreversed:"hid" %}
            <tr {% if not file.visible %}class='hidden' {% endif %}>
                {% if forloop.first %}
                <script>
                        var autorefresh = setInterval(refresh, 5000);
                        {% if 'ok' in file.state %}
                            clearInterval(autorefresh);
                        {% endif %}
                </script>
                {% endif %}
                <td id="{{ file.id }}" data=''></td>
                <td>{{ file.hid }}.</td>
                <td>{{ file.name }}</td>
                <td id="state_{{ file.id }}">
                    {% if 'ok' in file.state %}
                    <span class="glyphicon glyphicon-ok  text-success"
                          data-toggle="tooltip" data-placement="right"
                          title="Success!">
                    </span>
                    {% elif 'queued' in file.state or 'new' in file.state %}
                    <span class="glyphicon glyphicon-time spin text-info"
                          data-toggle="tooltip" data-placement="right"
                          title="Waiting to be launch">
                    </span>
                    {% elif "running" in file.state %}
                    <span class="glyphicon glyphicon-refresh spin"
                          data-toggle="tooltip" data-placement="right"
                          title="Your job is running">
                    </span>
                    {% else %}
                    <span class="glyphicon glyphicon-remove text-danger"
                          data-toggle="tooltip" data-placement="right"
                          title="Your job fail">
                    </span>
                    {% endif %}
                </td>
                <td id="action_{{ file.id }}">
                    {% if 'ok' in file.state %}
                    {# <a class="btn btn-default" title="Export big data in your personal outputs folder" #}
                          {# href="{% url 'export_file' file.id %}"> #}
                    {# <span class="glyphicon glyphicon-export text-primary" aria-hidden="true"></span></a>#}
                    <a class="btn btn-default" title="Dowload the file"
                       data-toggle="tooltip" data-placement="right"
                       href="{% url 'download_file' file.id %}">
                        <span class="glyphicon glyphicon-download-alt text-primary"></span></a>
                    <a class="btn btn-default"
                       href="{% url 'display_file' file.id %}"
                       data-toggle="tooltip" data-placement="right"
                       title="Display this file in your web browser">
                        {% if file.extension in "svg" %}
                        <span class="glyphicon glyphicon-picture"></span> .SVG</a>
                    {% else %}
                    <span class="glyphicon glyphicon-eye-open text-primary">
                        </span> .{{ file.extension }}</a>
                    {% endif %}
                    {% if file.extension in "nhx,nwk" %}
                    <a class="btn btn-success" title="Open Interactive Tree visualisation"
                       href="{% url 'display_tree' file.id %}"
                       data-toggle="tooltip" data-placement="right">
                        <span class="glyphicon text-success" aria-hidden="true">
                            <img src="{% static 'images/ptree.svg' %}">
                        </span>
                        Interactive tree
                    </a>
                    <a class="btn btn-warning" title="Export tree to iTOL: Interactive Tree Of Life"
                       href="{% url 'export_to_itol' file.id %}" target="_blank"
                       data-toggle="tooltip" data-placement="right"
                       title="Export your newick tree into iTol, external tree viewer">
                        <span class="glyphicon glyphicon-export" aria-hidden="true"> </span>
                        Export to iTol
                    </a>
                    {% endif %}
                    {% if file.extension in "fasta,fsa,msa,fna" %}
                    <a class="btn btn-info" title="MSAViewer"
                       href="{% url 'display_msa' file.id %}"
                       data-toggle="tooltip" data-placement="right"
                       title="Multipe sequences viewer">
                        <span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span>
                        MSAViewer
                    </a>
                    {% endif %}
                    {% elif 'error' in file.state %}
                    <a class="btn btn-default" title="shows error"
                       href="{% url 'galaxy_error_url' file.id %}">
                        <span class="glyphicon glyphicon-exclamation-sign text-danger"></span>
                    </a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>
</div>